name: Automated Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # Scheduled Unit Tests
  # ==========================================
  unit-tests:
    name: ğŸ• Scheduled Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        pip install -r requirements.txt
    
    - name: ğŸ“ Create Test Environment
      run: |
        mkdir -p data results models tests
        python tests/create_test_data.py || echo "Using basic setup"
    
    - name: ğŸ§ª Run Scheduled Tests
      run: |
        echo "ğŸ§ª Running scheduled tests..."
        export PYTHONPATH="$(pwd)/src:$PYTHONPATH"
        
        echo "ğŸ” Testing core modules..."
        modules_tested=0
        modules_passed=0
        
        echo "Testing audio_processing module..."
        if python -c "from audio_processing import DatasetAudioProcessor; print('âœ… Audio processing: PASS')"; then
          modules_passed=$((modules_passed + 1))
        else
          echo "âŒ Audio processing: FAIL"
        fi
        modules_tested=$((modules_tested + 1))
        
        echo "Testing disfluency_detector module..."
        if python -c "from disfluency_detector import DisfluencyDetector; print('âœ… Disfluency detector: PASS')"; then
          modules_passed=$((modules_passed + 1))
        else
          echo "âŒ Disfluency detector: FAIL"
        fi
        modules_tested=$((modules_tested + 1))
        
        echo "Testing model_evaluation module..."
        if python -c "from model_evaluation import ModelManager; print('âœ… Model evaluation: PASS')"; then
          modules_passed=$((modules_passed + 1))
        else
          echo "âŒ Model evaluation: FAIL"
        fi
        modules_tested=$((modules_tested + 1))
        
        echo "ğŸ“Š Results: $modules_passed/$modules_tested modules passed"
        if [ $modules_passed -eq $modules_tested ]; then
          echo "âœ… All tests passed!"
          exit 0
        else
          echo "âŒ Some tests failed"
          exit 1
        fi

  # ==========================================
  # Performance Check
  # ==========================================
  performance:
    name: ğŸ“ˆ Performance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install psutil
        pip install -r requirements.txt
    
    - name: ğŸ“Š Performance Check
      run: |
        echo "ğŸ“Š Running performance checks..."
        export PYTHONPATH="$(pwd)/src:$PYTHONPATH"
        
        echo "ğŸ’¾ System Resources:"
        python -c "import psutil; print(f'CPU: {psutil.cpu_percent(interval=1):.1f}%'); print(f'Memory: {psutil.virtual_memory().percent:.1f}%')" || echo "âš ï¸ psutil not available"
        
        echo "â±ï¸ Testing ModelManager load time..."
        python -c "import time; start = time.time(); from model_evaluation import ModelManager; load_time = time.time() - start; print(f'â±ï¸ ModelManager load: {load_time:.3f}s'); print('âœ… Performance OK' if load_time < 5.0 else 'âš ï¸ Slow performance')" || echo "âŒ Performance test failed"

  # ==========================================
  # Health Summary
  # ==========================================
  health-summary:
    name: ğŸ“‹ Health Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, performance]
    if: always()
    
    steps:
    - name: ğŸ“‹ Generate Report
      run: |
        echo "ğŸ“‹ Josh Talks Health Report"
        echo "=========================="
        echo "ğŸ• Date: $(date)"
        echo "ğŸ§ª Unit Tests: ${{ needs.unit-tests.result }}"
        echo "ğŸ“ˆ Performance: ${{ needs.performance.result }}"
        echo "=========================="
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.performance.result }}" == "success" ]]; then
          echo "âœ… All health checks passed!"
        else
          echo "âš ï¸ Some health checks failed"
        fi
